# 7. Python and Excel

![Excel][excel_image]

## Aim
Process an excel file with Python, fetch some real web data and write computations back to it

## Excel spreadsheets :sparkle:
- We now have some Excel spreadsheets, saved in the default **.xlsx** format
- **transactions.xlsx** is a record of all the client transactions since the beginning of the year
    - It was generated by the *generate_excel.py* but you don't need to know that :smirk:
- **costs_and_prices.xlsx** indicate the following information:
    - The cost of an item
        - It is the cost to manufacture and ship the item
        - It is in *CNY* :yen: because our products are all made in China :blush:
    - The price of an item is the price at which it is sold to the client (with 15% tax :weary:)
        - So we need to deduce these 15% we have to pay to the state from our gains
        - These are in *EUR* :euro: because we ship to European countries
    - The fixed costs
        - This indicates the costs of the warehouse, the web server etc. per week
        - This one is in *GBP* :pound: because the company is actually based in UK :gb:
    - Note that our final revenues or profits are in *GBP*
    - **Assume** we exchange these currencies at each transaction automatically
    
## What the shop wants from us :convenience_store:
1. Write the overall sales of all transactions in *EUR* to *transactions.xlsx*
2. Display in Python a sorted list of the customers spending the most in a descending order
3. Calculate the variable profit in *GBP* of each transaction, taking into account:
    - Cost of an item and the GBPCNY exchange rate at the date and time of transaction, UK timezone
    - Price of an item and the past EURGBP exchange rate at the date and time of transaction, UK timezone
    - **DO NOT TAKE INTO ACCOUNT** the *fixed costs*
    - Write the results in an extra column in *transactions.xlsx*
4. Write to *transactions.xlsx* the overall profit in GBP since the beginning of the year
    - Take the fixed costs into account
    - Use the column previously created in 3
5. Optional: Provide a sorted list of the best selling week days (i.e Monday) in a descending order 

***

## Spring cleaning of our Python
- We are going to reuse what we have done previously
- In *mycode.py* just remove:
    - The main code from line **22** to line **34**
    - Any `print` statements you may have at the end (without being in a function)
- Rename *mycode.py* to *calculations.py*
- Create a new Python file *excel.py*, open it in *Liclipse* and add the following content and **SAVE**:
```python
from calculations import Transaction, find_total_sales, find_participation, find_client_max_spent
# The line above uses what we have worked on previously

def read_transactions(worksheet):   
    legend = worksheet['1']
    #["Date", "Time", "Client", "Trees bought", "Gnomes bought", "Chocolates bought", "Balls bought"]
    transactions = []
    number_transactions = len(worksheet['A']) - 1 #-1 for legend
    for row in range(2, number_transactions):
        date = worksheet.cell(row = row, col = 1)
        time = worksheet.cell(row = row, col = 2)
        client = worksheet.cell(row = row, col = 3)
        trees = worksheet.cell(row = row, col = 4)
        gnomes = worksheet.cell(row = row, col = 5)
        chocolates = worksheet.cell(row = row, col = 6)
        balls = worksheet.cell(row = row, col = 7)
        transaction = Transaction(date, time, client, trees, gnomes, chocolates, balls)
        transactions.append(transaction)
    return transactions  
                
if __name__ == "__main__":
    # This is where the main code is ran if you run this file
    # we use that weird __name__ thingy so that you can IMPORT that file elsewhere
    workbook = load_workbook("transactions.xlsx")
    worksheet = workbook['Transactions']
    transactions = read_transactions(worksheet)
    print "First transaction: "+str(transactions[0])
    print "Last transaction: "+str(transactions[-1])
    
    # Adding something to the worksheet
    worksheet.cell(row = 1, col = 8, value = "Trolling Hard") # Writes at the end of the legend row
    workbook.save("transactions.xlsx") #You need to save back your changes
```
- It will show errors related to *load_workbook* but we're getting there...

## PIP Install Packages (*recursive acronym*)
1. Python does not *understand* **.xlsx** files yet, we need to add a package
2. It's dead simple.
    - [Google python xlsx][google_xlsx] and the first thing you see is **openpyxl**
    - Open a terminal, enter `pip install openpyxl`
    - At the top of **excel.py** just add and the SAVE:
    ```python
    from openpyxl import load_workbook
    ```
    - You can now use the *load_workbook* function to read an Excel file in Python !!
3. Let's not forget about *Vagrant*... 
    - Look at the *Vagrantfile* with your code editor (**TIP:** Enter `cat Vagrantfile`) and you should see that:
    ```shell
    cd /vagrant
    sudo pip install -r requirements.txt  
    ```
    - First line changes your directory (`cd`) to the shared directory `/vagrant` :file_folder:
    - Second line tells **pip** to install what is asked for in the *requirements.txt* file
    - Open *requirements.txt*... **NOTHING ?** *Yes.* Because we did not need any packages yet.
    - Just add **openpyxl** to the first line of *requirements.txt*
    - Next time, use `vagrant up --provision` to install that package in Vagrant :wink:

***

## Tasks
### 1. Overall sales of all transactions in EUR


***

## To add to your resume
- openpyxl
- Liclipse
- Yahoo Finance
- Maybe YQL eventually
  
[excel_image]: /internals/icons/excel.ico
[google_xlsx]: https://www.google.com/search?q=python%20xlsx