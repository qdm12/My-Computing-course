# 7. Python and Excel

![Excel][excel_image]

## Aim
Process an excel file with Python, fetch some real web data and write computations back to it

## Excel spreadsheets :sparkle:
- We now have some Excel spreadsheets, saved in the default **.xlsx** format
- **transactions.xlsx** is a record of all the client quantity purchases since the beginning of the year
    - It was generated by the *generate_excel.py* but you don't need to know that :smirk:
- **costs_and_prices.xlsx** indicates the following information:
    - The cost of an item (**only used in lesson 9**)
        - It is the cost to manufacture and ship the item
        - It is in *CNY* :yen: because our products are all made in China :blush:
    - The price of an item is the price at which it is sold to the client (with 15% tax :weary:)
        - So we need to deduce these 15% we have to pay to the state from our gains (**only used in lesson 9**)
        - These are in *EUR* :euro: because we ship to European countries
    - The fixed costs  (**only used in lesson 9**)
        - This indicates the costs of the warehouse, the web server etc. per week
        - This one is in *GBP* :pound: because the company is actually based in UK :gb:
    - Note that our final revenues or profits are in *GBP*  (**only used in lesson 9**)
    - **Assume** we exchange these currencies at each transaction automatically  (**only used in lesson 9**)
    
## What the shop wants from us :convenience_store:
1. Write the overall sales of all transactions in *EUR* to *transactions.xlsx*
2. Display in Python a sorted list of the customers spending the most in a descending order
3. Provide a sorted list of the best selling week days (i.e Monday) in a descending order 

***

## Spring cleaning of our Python
- We are going to reuse what we have done previously
- In *mycode.py* just remove:
    - The main code from line **22** to line **34**
    - Any `print` statements you may have at the end (without being in a function)
- Rename *mycode.py* to *calculations.py*
- Create a new Python file *excel.py*, open it in *Liclipse* and add the following content and **SAVE**:
```python
from calculations import Transaction, find_total_sales
# The line above uses the find_total_sales function we have wrote previously

def read_transactions(worksheet):   
    legend = worksheet['1']
    #["Date", "Time", "Client", "Trees bought", "Gnomes bought", "Chocolates bought", "Balls bought"]
    transactions = []
    number_transactions = len(worksheet['A']) - 1 #-1 for legend
    for row in range(2, number_transactions):
        date = worksheet.cell(row = row, col = 1)
        time = worksheet.cell(row = row, col = 2)
        client = worksheet.cell(row = row, col = 3)
        trees = worksheet.cell(row = row, col = 4)
        gnomes = worksheet.cell(row = row, col = 5)
        chocolates = worksheet.cell(row = row, col = 6)
        balls = worksheet.cell(row = row, col = 7)
        transaction = Transaction(date, time, client, trees, gnomes, chocolates, balls)
        transactions.append(transaction)
    return transactions  
                
if __name__ == "__main__":
    # This is where the main code is ran if you run this file
    # we use that weird __name__ thingy so that you can IMPORT that file elsewhere
    workbook = load_workbook("transactions.xlsx")
    worksheet = workbook['Transactions']
    transactions = read_transactions(worksheet)
    print "First transaction: "+str(transactions[0])
    print "Last transaction: "+str(transactions[-1])
    
    # Adding something to the worksheet
    worksheet.cell(row = 1, col = 8, value = "Trolling Hard") # Writes at the end of the legend row
    workbook.save("transactions.xlsx") #You need to save back your changes
```
- It will show errors related to *load_workbook* but we're getting there...

## PIP Install Packages (*recursive acronym*)
1. Python does not *understand* **.xlsx** files yet, we need to add a package
2. It's dead simple.
    - [Google python xlsx][google_xlsx] and the first thing you see is **openpyxl**
    - Open a terminal, enter `pip install openpyxl`
    - At the top of **excel.py** just add and the SAVE:
    ```python
    from openpyxl import load_workbook
    ```
    - You can now use the *load_workbook* function to read an Excel file in Python !!
3. Let's not forget about *Vagrant*... 
    - Look at the *Vagrantfile* with your code editor (**TIP:** Enter `cat Vagrantfile`) and you should see that:
    ```shell
    cd /vagrant
    sudo pip install -r requirements.txt  
    ```
    - First line changes your directory (`cd`) to the shared directory `/vagrant` :file_folder:
    - Second line tells **pip** to install what is asked for in the *requirements.txt* file
    - Open *requirements.txt*... **NOTHING ?** *Yes.* Because we did not need any packages yet.
    - Just add **openpyxl** to the first line of *requirements.txt*
    - Next time, use `vagrant up --provision` to install that package in Vagrant :wink:

***

## Tasks
### PART 1 OF 3: Overall sales of all transactions in EUR
- Add the two following functions in **excel.py** and fill up *read_prices()*:
```python
def read_prices():
    prices = dict()
    # Open workbook costs_and_prices.xlsx and read prices cells from it
    # Get the name and the price of each item
    # Then store the name and value of the item with prices[name] = value
    return prices
    
def write_total_sales_EUR(worksheet, total_sales_EUR):
    N = len(worksheet['A']) #Number of transactions + legend
    worksheet.cell(row = 1, col = N+1, value = total_sales_EUR)
    # The following line formats the cell as the EUR currency number in Excel
    worksheet.cell(row = 1, col = N+1).number_format = '"EUR "#,##0.00'
```
- Then replace the `__name__ == "__main__":` block with:
```python
if __name__ == "__main__":
    workbook = load_workbook("transactions.xlsx")
    worksheet = workbook['Transactions']
    transactions = read_transactions(worksheet)
    prices = read_prices()
    #Now we use find_total_sales that we wrote before
    total_sales_EUR = find_total_sales(transactions, prices)
    write_total_sales_EUR(worksheet, total_sales_EUR)
    workbook.save("transactions.xlsx") #overwrites the previous version
```

### PART 2 OF 3: Sorted list of the customers spending the most
- Just comment out the three last lines of the main code of **excel.py**:
```python
if __name__ == "__main__":
    workbook = load_workbook("transactions.xlsx")
    worksheet = workbook['Transactions']
    transactions = read_transactions(worksheet)
    prices = read_prices()
    """
    #Now we use find_total_sales that we wrote before
    total_sales_EUR = find_total_sales(transactions, prices)
    write_total_sales_EUR(worksheet, total_sales_EUR)
    workbook.save("transactions.xlsx") #overwrites the previous version
    """
```
- In **excel.py**, add `, sort_clients_by_spending` on the `from calculations import` line
- In **excel.py**, add the following at the end of the main code:
```python
    clients_money_spent_sorted = sort_clients_by_spending(transactions, prices)
    # We are only interested in the clients, not the amount they spent so:
    print "Clients ranking: ",
    for element in clients_money_spent_sorted:
        print element[0] + ", ",
    print
```

## PART 3 OF 3: Provide a sorted list of the best selling week days (i.e Monday) in a descending order 
- This is similar to part 2 except that we are dealing with day names and not client names.
- First things first: find the name of the day from the date
	- Let's add the function `date_to_day(year, month, day)` in **calculations.py**
	- Just [Google it](https://www.google.com/webhp?#q=find+name+of+day+from+date+python), click on the first link!
	- Now to me the fifth answer seems great, understandable and short but it's up to you ! **TIP:** Test it in your terminal with `python`
	- The function would then be
	```python
	from datetime import date #add this to the top of calculations.py
	
	date_to_day(year, month, day):
		start_of_year = date(year, month, day)
		start_of_year_day = start_of_year.strftime("%A")
		return start_of_year_day
	```
- Just to simplify our life now and in the future add that short function:
```python
def get_transaction_spending(transaction, prices):
    spending = transaction.trees * prices["tree"] + \
               transaction.gnomes * prices["gnome"] + \
               transaction.chocolates * prices["chocolate"] + \
               transaction.balls * prices["ball"]
    return spending    
```
- Now add the following function skeleton in **calculations.py** and finish it:
```python
def find_sorted_best_selling_week_days(transactions, prices):
    weekdays = dict()
    weekdays["Monday"] = 0
    # ... until "Sunday" initiate all them to 0 (EUR)
    for transaction in transactions:
        day_name = date_to_day(transaction.date)
        weekdays[day_name] += get_transaction_spending(transaction)
    # You now have the dictionary with all the sales on each week days for all transactions
    # There are also other ways to do this but it's up to you
    sorted_best_selling_week_days = sorted(weekdays.items(), key=itemgetter(1), reverse=True)
    return sorted_best_selling_week_days #same thing as before, that's a list of tuples    
```
- Finally in the main code, test the function with
```python
    # ...
    best_days = find_sorted_best_selling_week_days(transactions, prices)
    position = 1
    # BTW you can also just try print best_days to understand its structure etc
    for day in best_days:
        print "Position "+str(position)+": "+day[0]+" with a total spending of "+str(day[1])+" EUR"
        position += 1        
```
- **BE SURE** that all these parts work otherwise the next lessons will fail at some point

***

## What did you learn? 
- Install Python packages with **pip**
- Use **openpyxl** to read data from an Excel file
- Use **openpyxl** and Excel currency formatting to write data to an Excel file
- Use multiple Python files (or *modules*)
- `from xxx import yyy` command to use packages and your own files
- Re-use of your own code

## To add to your resume
- openpyxl
- Liclipse
  
Time to take a Python break and [use Slack]

[excel_image]: /internals/icons/excel.ico
[google_xlsx]: https://www.google.com/search?q=python%20xlsx
[lesson_08]: /08.%20Slack